<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Access Check</title>
  <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding-top: 50px; }
  </style>
</head>
<body>
  <h2>Checking Access...</h2>

<script>
  const msalConfig = {
    auth: {
      clientId: 'd13c0cca-d75f-4bc9-8dcb-b18315c40d0e', // Replace this
      authority: 'https://login.microsoftonline.com/a456fbc2-921d-42a4-a7a8-fc0f343ede61', // Replace this
      redirectUri: window.location.href
    }
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  async function signInAndCheckAccess() {
    try {
      const loginResponse = await msalInstance.loginPopup({
        scopes: ["User.Read"]
      });

      console.log("Login response:", loginResponse);

      const account = loginResponse.account || msalInstance.getAllAccounts()[0];

      if (!account) {
        document.body.innerHTML = "<h2>Could not identify user.</h2>";
        return;
      }

      const userEmail = account.username;
      document.body.innerHTML = `<h2>Welcome, ${userEmail}</h2><p>Verifying access...</p>`;

      checkSharePointList(userEmail);

    } catch (error) {
      console.error("Login failed:", error);
      document.body.innerHTML = "<h2>Login Failed</h2><p>Please try again or contact support.</p>";
    }
  }

  async function checkSharePointList(email) {
    try {
      const tokenResponse = await msalInstance.acquireTokenSilent({
        scopes: ["https://graph.microsoft.com/.default"],
        account: msalInstance.getAllAccounts()[0]
      });

      const token = tokenResponse.accessToken;

      const siteId = "YOUR_SITE_ID";  // Replace
      const listId = "YOUR_LIST_ID";  // Replace

      const filter = encodeURIComponent(`fields/Email eq '${email}'`);
      const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${listId}/items?$expand=fields&$filter=${filter}`;

      const response = await fetch(url, {
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        }
      });

      const result = await response.json();
      console.log("Graph response:", result);

      if (result.value && result.value.length > 0) {
        window.location.href = "https://forms.office.com/your-form-link"; // Replace
      } else {
        document.body.innerHTML = "<h2>Access Denied</h2><p>You are not authorized to access this form.</p>";
      }

    } catch (err) {
      console.error("Graph error:", err);
      document.body.innerHTML = "<h2>Error</h2><p>There was a problem verifying your access.</p>";
    }
  }

  // Trigger login + check on load
  signInAndCheckAccess();
</script>

</body>
</html>
