<!DOCTYPE html>
<html>
<head>
  <title>Access Check</title>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h2>Checking access...</h2>

  <script>
    const msalConfig = {
      auth: {
        clientId: 'd13c0cca-d75f-4bc9-8dcb-b18315c40d0e',
        authority: 'https://login.microsoftonline.com/a456fbc2-921d-42a4-a7a8-fc0f343ede61',
        redirectUri: 'https://thejapachipala.github.io/qr-access-check/Login.html'
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function checkAccess(email) {
      const encodedUrl = "https://yourdomain.sharepoint.com/sites/yoursite/_api/web/lists/getbytitle('AccessList')/items?$select=Email";

      try {
        const response = await fetch(encodedUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json;odata=verbose'
          }
        });

        if (!response.ok) throw new Error("SharePoint fetch failed");

        const data = await response.json();
        const users = data.d.results.map(item => item.Email.toLowerCase());

        if (users.includes(email.toLowerCase())) {
          // âœ… Redirect to Microsoft Form
          window.location.href = "https://forms.office.com/r/your-form-id";
        } else {
          document.body.innerHTML = "<h2>Access Denied</h2><p>You are not authorized to access this form.</p>";
        }

      } catch (err) {
        console.error("Access check error:", err);
        document.body.innerHTML = "<h2>Error checking access</h2>";
      }
    }

    async function authenticateUser() {
      try {
        const loginResponse = await msalInstance.loginPopup({ scopes: ['User.Read'] });
        const email = loginResponse.account.username;

        document.body.innerHTML = `<h2>Welcome, ${email}</h2><p>Authentication successful. Checking access...</p>`;
        checkAccess(email);

      } catch (error) {
        console.error("Authentication failed:", error);
        document.body.innerHTML = "<h2>Login failed</h2><p>See console for details.</p>";
      }
    }

    authenticateUser();
  </script>
</body>
</html>
