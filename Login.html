<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Access Check</title>
</head>
<body>
  <h2>Checking access...</h2>
  <div id="status"></div>

  <!-- MSAL.js -->
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>

  <script>
    class SharePointAccessChecker {
      constructor(config) {
        this.clientId = config.clientId;
        this.tenantId = config.tenantId;
        this.redirectUri = config.redirectUri;
        this.graphSiteId = config.graphSiteId;
        this.listName = config.listName;

        this.msalInstance = new msal.PublicClientApplication({
          auth: {
            clientId: this.clientId,
            authority: `https://login.microsoftonline.com/${this.tenantId}`,
            redirectUri: this.redirectUri,
          },
          system: {
            loggerOptions: {
              loggerCallback: (level, message, containsPii) => {
                if (!containsPii) console.log(message);
              },
              logLevel: msal.LogLevel.Verbose,
              piiLoggingEnabled: false
            }
          }
        });

        this.statusDiv = document.getElementById("status");
      }

      updateStatus(message, isError = false) {
        this.statusDiv.innerHTML = `<p style="color:${isError ? 'red' : 'black'}">${message}</p>`;
      }

      async getAccessToken(scopes) {
        const accounts = this.msalInstance.getAllAccounts();
        if (accounts.length === 0) {
          const loginResponse = await this.msalInstance.loginPopup({ scopes });
          return loginResponse.accessToken;
        }

        const account = accounts[0];
        try {
          const tokenResponse = await this.msalInstance.acquireTokenSilent({
            account,
            scopes
          });
          return tokenResponse.accessToken;
        } catch (error) {
          console.warn("Silent token acquisition failed, using popup.");
          const loginResponse = await this.msalInstance.loginPopup({ scopes });
          return loginResponse.accessToken;
        }
      }

      async checkUserAccess(token, email) {
        let url = `https://graph.microsoft.com/v1.0/sites/${this.graphSiteId}/lists/${encodeURIComponent(this.listName)}/items?$expand=fields&$top=999`;
        let lowerEmail = email.toLowerCase();

        while (url) {
          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json"
            }
          });

          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`API Error (${response.status}): ${errorBody}`);
          }

          const data = await response.json();
          const items = data.value || [];

          const found = items.find(item =>
            item.fields?.Username?.toLowerCase() === lowerEmail
          );
          if (found) return true;

          url = data["@odata.nextLink"];
        }

        return false;
      }

      async authenticateAndCheck() {
        this.updateStatus("Authenticating...");
        try {
          const token = await this.getAccessToken(['User.Read', 'Sites.Read.All']);

          const accounts = this.msalInstance.getAllAccounts();
          if (accounts.length === 0) {
            this.updateStatus("No account found after login.", true);
            return;
          }

          const userEmail = accounts[0].username;
          this.updateStatus(`Welcome, ${userEmail}. Checking SharePoint access...`);

          const accessGranted = await this.checkUserAccess(token, userEmail);
          if (accessGranted) {
            this.statusDiv.innerHTML = `
              <h2>Access Granted</h2>
              <p>Welcome, ${userEmail}</p>
              <a href="https://forms.cloud.microsoft/r/Saurgpg1XQ" target="_blank">Go to MS Form</a>
            `;
          } else {
            this.statusDiv.innerHTML = `
              <h2>Not Authorized</h2>
              <p>${userEmail} is not listed in ${this.listName}.</p>
            `;
          }
        } catch (error) {
          console.error("Authentication or access check failed:", error);
          this.updateStatus("Error during authentication or access check. See console for details.", true);
        }
      }
    }

    // ðŸ”§ Configure your settings here
    const config = {
      clientId: "d13c0cca-d75f-4bc9-8dcb-b18315c40d0e",         // ðŸ‘ˆ Replace with your Azure AD app ID
      tenantId: "a456fbc2-921d-42a4-a7a8-fc0f343ede61",         // ðŸ‘ˆ Replace with your Azure Tenant ID
      redirectUri: "https://thejapachipala.github.io/qr-access-check/Login.html",  // ðŸ‘ˆ Replace if needed
      graphSiteId: "https://smartinfrastructure.sharepoint.com/teams/Pool_Vehicles2",        // ðŸ‘ˆ Replace with your SharePoint site ID
      listName: "Approved_Drivers",       // ðŸ‘ˆ SharePoint list name
    };

    // ðŸš€ Start the process
    const checker = new SharePointAccessChecker(config);
    checker.authenticateAndCheck();
  </script>
</body>
</html>
